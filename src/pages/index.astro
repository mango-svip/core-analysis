---
import Layout from "../layouts/Layout.astro";

interface RepoItem {
    term: string;
    zxj: string;
    yield: string;
    lockDays: string;
    availableDay: string;
    bestOnGivenDay?: boolean;
}

interface ApiResponse {
    code: number;
    data: {
        data: {
            sz: RepoItem[];
            sh: RepoItem[];
        };
        bestOnGivenDay: {
            sc: string;
            term: string;
        };
    };
}

const url = 'https://proxy.finance.qq.com/ifzqgtimg/appstock/app/ReverseRepo/get?app=wzq';
const response = await fetch(url);
const json: ApiResponse = await response.json();
const isError = json == null || json.code !== 0;

if (isError) {
    throw new Error('æ•°æ®è·å–å¤±è´¥');
}

const data = json.data.data;
const bestOnGivenDay = json.data.bestOnGivenDay;
const szData = data.sz;
const shData = data.sh;

const requestUrl = new URL(Astro.request.url);
const buyAmountParam = requestUrl.searchParams.get('buyAmount');
const buyAmount = buyAmountParam ? parseFloat(buyAmountParam) : 10;
const profitParam = requestUrl.searchParams.get('profit');
const profit = profitParam ? parseFloat(profitParam) : 0.45;

const rateMap: Record<string, number> = {
    '1': 0.00001,
    '2': 0.00002,
    '3': 0.00003,
    '4': 0.00004,
    '7': 0.00005,
    '14': 0.00010,
    '28': 0.00020,
    '91': 0.00030,
    '182': 0.00030
};

// è®¡ç®—æ”¶ç›Šçš„å‡½æ•°
function calculateEarnings(item: RepoItem, amount: number) {
    const fee = amount * 10000 * (rateMap[item.term] || 0);
    const grossEarnings = amount * 10000 * parseFloat(item.zxj) * parseInt(item.lockDays) / 100 / 365;
    const netEarnings = grossEarnings - fee;
    const dailyReturn = netEarnings / parseInt(item.lockDays);
    const dailyReturnPer10k = dailyReturn / (amount * 10000) * 10000;
    
    return {
        fee,
        grossEarnings,
        netEarnings,
        dailyReturn,
        dailyReturnPer10k
    };
}

// ä¸ºæ•°æ®æ·»åŠ æœ€ä½³æ¨èæ ‡è®°å’Œè®¡ç®—æ”¶ç›Š
const processedShData = shData.map((item: RepoItem) => {
    const earnings = calculateEarnings(item, buyAmount);
    return {
        ...item,
        bestOnGivenDay: bestOnGivenDay.sc === 'sh' && bestOnGivenDay.term === item.term,
        earnings
    };
});

const processedSzData = szData.map((item: RepoItem) => {
    const earnings = calculateEarnings(item, buyAmount);
    return {
        ...item,
        bestOnGivenDay: bestOnGivenDay.sc === 'sz' && bestOnGivenDay.term === item.term,
        earnings
    };
});

// æ‰¾å‡ºæœ€ä½³æ”¶ç›Šé€‰é¡¹
const allData = [...processedShData, ...processedSzData];
const bestOption = allData.reduce((best, current) => 
    current.earnings.dailyReturnPer10k > best.earnings.dailyReturnPer10k ? current : best
);

---

<Layout title="å›½å€ºé€†å›è´­">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">å›½å€ºé€†å›è´­æ”¶ç›Šè®¡ç®—å™¨</h1>
                <p class="text-gray-600">æ™ºèƒ½åˆ†ææœ€ä½³æŠ•èµ„æ–¹æ¡ˆ</p>
            </div>

            <!-- æœ€ä½³æ¨èå¡ç‰‡ -->
            <div class="bg-gradient-to-r from-green-400 to-blue-500 rounded-2xl p-6 mb-8 text-white shadow-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold mb-2">ğŸ† ä»Šæ—¥æœ€ä½³é€‰æ‹©</h2>
                        <div class="text-lg">
                            <span class="font-semibold">{bestOption.term}å¤©æœŸ</span>
                            <span class="mx-2">â€¢</span>
                            <span>{bestOption.zxj}% å¹´åŒ–æ”¶ç›Šç‡</span>
                        </div>
                        <div class="text-sm opacity-90 mt-1">
                            æ¯ä¸‡å…ƒæ—¥æ”¶ç›Š: Â¥{bestOption.earnings.dailyReturnPer10k.toFixed(4)}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold">Â¥{bestOption.earnings.netEarnings.toFixed(2)}</div>
                        <div class="text-sm opacity-90">é¢„æœŸæ€»æ”¶ç›Š</div>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                    <!-- è´­ä¹°é‡‘é¢è¾“å…¥ -->
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">è´­ä¹°é‡‘é¢</label>
                            <div class="flex items-center">
                                <input 
                                    type="number" 
                                    id="buyAmount" 
                                    value={buyAmount}
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="è¾“å…¥é‡‘é¢"
                                />
                                <span class="ml-2 text-gray-600">ä¸‡å…ƒ</span>
                            </div>
                        </div>
                    </div>

                    <!-- æ’åºé€‰æ‹© -->
                    <div class="flex items-center justify-center">
                        <div class="bg-gray-100 p-1 rounded-xl inline-flex">
                            <button
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-blue-500 text-white shadow-sm" 
                                id="sortToggleByReturn"
                            >
                                æŒ‰æ”¶ç›Šæ’åº
                            </button>
                            <button 
                                class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-gray-600 hover:text-gray-800" 
                                id="sortToggleByLock"
                            >
                                æŒ‰æœŸé™æ’åº
                            </button>
                        </div>
                    </div>

                    <!-- å¸‚åœºé€‰æ‹© -->
                    <div class="flex items-center justify-center">
                        <div class="bg-gray-100 p-1 rounded-xl inline-flex">
                            <button
                                class="px-6 py-2 rounded-lg text-sm font-medium transition-all duration-200 bg-red-500 text-white shadow-sm" 
                                id="marketSH"
                            >
                                æ²ªå¸‚
                            </button>
                            <button 
                                class="px-6 py-2 rounded-lg text-sm font-medium transition-all duration-200 text-gray-600 hover:text-gray-800" 
                                id="marketSZ"
                            >
                                æ·±å¸‚
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®åˆ—è¡¨ -->
            <div id="shContainer" class="space-y-4">
                {processedShData.map((item) => (
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden" data-key="gc">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                                        {item.term}
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800">{item.term}å¤©æœŸ</h3>
                                        <p class="text-sm text-gray-500">{item.availableDay}</p>
                                    </div>
                                    {item.bestOnGivenDay && (
                                        <span class="px-3 py-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-xs font-bold rounded-full shadow-lg">
                                            å®˜æ–¹æ¨è
                                        </span>
                                    )}
                                    {item === bestOption && (
                                        <span class="px-3 py-1 bg-gradient-to-r from-green-400 to-blue-500 text-white text-xs font-bold rounded-full shadow-lg">
                                            æœ€ä½³æ”¶ç›Š
                                        </span>
                                    )}
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-blue-600">{item.zxj}%</div>
                                    <div class="text-sm text-gray-500">å¹´åŒ–æ”¶ç›Šç‡</div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-sm text-gray-500 mb-1">é”å®šå¤©æ•°</div>
                                    <div class="text-lg font-semibold text-gray-800" data-key="lockDays">{item.lockDays}å¤©</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-sm text-gray-500 mb-1">æ‰‹ç»­è´¹</div>
                                    <div class="text-lg font-semibold text-gray-800">Â¥{item.earnings.fee.toFixed(2)}</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-sm text-gray-500 mb-1">æ€»æ”¶ç›Š</div>
                                    <div class="text-lg font-semibold text-green-600">Â¥{item.earnings.netEarnings.toFixed(2)}</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-sm text-gray-500 mb-1">ä¸‡å…ƒæ—¥æ”¶ç›Š</div>
                                    <div class="text-lg font-semibold text-blue-600" data-key="dailyReturn">Â¥{item.earnings.dailyReturnPer10k.toFixed(4)}</div>
                                </div>
                            </div>

                            <!-- æ”¶ç›Šå¯¹æ¯” -->
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">vs å¤©å¤©å®({profit}å…ƒ/ä¸‡å…ƒ/æ—¥)</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-gray-600">å·®é¢:</span>
                                        {(() => {
                                            const ttbTotal = parseInt(item.lockDays) * profit * buyAmount;
                                            const diff = item.earnings.netEarnings - ttbTotal;
                                            return (
                                                <span class={`font-semibold ${diff >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {diff >= 0 ? '+' : ''}Â¥{diff.toFixed(2)}
                                                </span>
                                            );
                                        })()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                ))}
            </div>

            <div id="szContainer" class="space-y-4 hidden">
                {processedSzData.map((item) => (
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden" data-key="gc">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-teal-600 rounded-full flex items-center justify-center text-white font-bold">
                                        {item.term}
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800">{item.term}å¤©æœŸ</h3>
                                        <p class="text-sm text-gray-500">{item.availableDay}</p>
                                    </div>
                                    {item.bestOnGivenDay && (
                                        <span class="px-3 py-1 bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-xs font-bold rounded-full shadow-lg">
                                            å®˜æ–¹æ¨è
                                        </span>
                                    )}
                                    {item === bestOption && (
                                        <span class="px-3 py-1 bg-gradient-to-r from-green-400 to-blue-500 text-white text-xs font-bold rounded-full shadow-lg">
                                            æœ€ä½³æ”¶ç›Š
                                        </span>
                                    )}
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-600">{item.zxj}%</div>
                                    <div class="text-sm text-gray-500">å¹´åŒ–æ”¶ç›Šç‡</div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-sm text-gray-500 mb-1">é”å®šå¤©æ•°</div>
                                    <div class="text-lg font-semibold text-gray-800" data-key="lockDays">{item.lockDays}å¤©</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-sm text-gray-500 mb-1">æ‰‹ç»­è´¹</div>
                                    <div class="text-lg font-semibold text-gray-800">Â¥{item.earnings.fee.toFixed(2)}</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-sm text-gray-500 mb-1">æ€»æ”¶ç›Š</div>
                                    <div class="text-lg font-semibold text-green-600">Â¥{item.earnings.netEarnings.toFixed(2)}</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-sm text-gray-500 mb-1">ä¸‡å…ƒæ—¥æ”¶ç›Š</div>
                                    <div class="text-lg font-semibold text-green-600" data-key="dailyReturn">Â¥{item.earnings.dailyReturnPer10k.toFixed(4)}</div>
                                </div>
                            </div>

                            <!-- æ”¶ç›Šå¯¹æ¯” -->
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-600">vs å¤©å¤©å®({profit}å…ƒ/ä¸‡å…ƒ/æ—¥)</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-gray-600">å·®é¢:</span>
                                        {(() => {
                                            const ttbTotal = parseInt(item.lockDays) * profit * buyAmount;
                                            const diff = item.earnings.netEarnings - ttbTotal;
                                            return (
                                                <span class={`font-semibold ${diff >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {diff >= 0 ? '+' : ''}Â¥{diff.toFixed(2)}
                                                </span>
                                            );
                                        })()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </div>
</Layout>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // å¸‚åœºåˆ‡æ¢åŠŸèƒ½
    const marketSH = document.getElementById('marketSH');
    const marketSZ = document.getElementById('marketSZ');
    const shContainer = document.getElementById('shContainer');
    const szContainer = document.getElementById('szContainer');

    marketSH?.addEventListener('click', function() {
        // æ›´æ–°æŒ‰é’®æ ·å¼
        marketSH.classList.add('bg-red-500', 'text-white', 'shadow-sm');
        marketSH.classList.remove('text-gray-600', 'hover:text-gray-800');
        marketSZ?.classList.remove('bg-red-500', 'text-white', 'shadow-sm');
        marketSZ?.classList.add('text-gray-600', 'hover:text-gray-800');
        
        // åˆ‡æ¢å®¹å™¨æ˜¾ç¤º
        shContainer?.classList.remove('hidden');
        szContainer?.classList.add('hidden');
    });

    marketSZ?.addEventListener('click', function() {
        // æ›´æ–°æŒ‰é’®æ ·å¼
        marketSZ.classList.add('bg-red-500', 'text-white', 'shadow-sm');
        marketSZ.classList.remove('text-gray-600', 'hover:text-gray-800');
        marketSH?.classList.remove('bg-red-500', 'text-white', 'shadow-sm');
        marketSH?.classList.add('text-gray-600', 'hover:text-gray-800');
        
        // åˆ‡æ¢å®¹å™¨æ˜¾ç¤º
        szContainer?.classList.remove('hidden');
        shContainer?.classList.add('hidden');
    });

    // æ’åºåŠŸèƒ½
    const sortByReturn = document.getElementById('sortToggleByReturn');
    const sortByLock = document.getElementById('sortToggleByLock');

    function sortItems(sortBy) {
        const activeContainer = shContainer?.classList.contains('hidden') ? szContainer : shContainer;
        if (!activeContainer) return;

        const items = Array.from(activeContainer.querySelectorAll('[data-key="gc"]'));
        
        items.sort((a, b) => {
            if (sortBy === 'return') {
                const aReturn = parseFloat(a.querySelector('[data-key="dailyReturn"]')?.textContent?.replace(/[Â¥,]/g, '') || '0');
                const bReturn = parseFloat(b.querySelector('[data-key="dailyReturn"]')?.textContent?.replace(/[Â¥,]/g, '') || '0');
                return bReturn - aReturn; // é™åº
            } else if (sortBy === 'lock') {
                const aLock = parseInt(a.querySelector('[data-key="lockDays"]')?.textContent?.replace(/[å¤©]/g, '') || '0');
                const bLock = parseInt(b.querySelector('[data-key="lockDays"]')?.textContent?.replace(/[å¤©]/g, '') || '0');
                return aLock - bLock; // å‡åº
            }
            return 0;
        });

        // é‡æ–°æ’åˆ—DOMå…ƒç´ 
        items.forEach(item => activeContainer.appendChild(item));
    }

    sortByReturn?.addEventListener('click', function() {
        // æ›´æ–°æŒ‰é’®æ ·å¼
        sortByReturn.classList.add('bg-blue-500', 'text-white', 'shadow-sm');
        sortByReturn.classList.remove('text-gray-600', 'hover:text-gray-800');
        sortByLock?.classList.remove('bg-blue-500', 'text-white', 'shadow-sm');
        sortByLock?.classList.add('text-gray-600', 'hover:text-gray-800');
        
        sortItems('return');
    });

    sortByLock?.addEventListener('click', function() {
        // æ›´æ–°æŒ‰é’®æ ·å¼
        sortByLock.classList.add('bg-blue-500', 'text-white', 'shadow-sm');
        sortByLock.classList.remove('text-gray-600', 'hover:text-gray-800');
        sortByReturn?.classList.remove('bg-blue-500', 'text-white', 'shadow-sm');
        sortByReturn?.classList.add('text-gray-600', 'hover:text-gray-800');
        
        sortItems('lock');
    });

    // è´­ä¹°é‡‘é¢è¾“å…¥åŠŸèƒ½
    const buyAmountInput = document.getElementById('buyAmount') as HTMLInputElement;
    
    function updateAmount() {
        const value = buyAmountInput?.value;
        if (!value || value === '') return;
        
        const url = new URL(window.location.href);
        url.searchParams.set('buyAmount', value);
        url.searchParams.set('profit', '0.45');
        window.location.href = url.href;
    }

    buyAmountInput?.addEventListener('blur', updateAmount);
    buyAmountInput?.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            updateAmount();
        }
    });

    // å¡ç‰‡æ‚¬åœæ•ˆæœ
    document.querySelectorAll('[data-key="gc"]').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});
</script>