---
// import GC from "../components/GC.astro";
import GCard from '../components/GCard.astro';
import GCardV0 from '../components/GCard_v0.astro';
import Layout from "../layouts/Layout.astro";

const url = 'https://proxy.finance.qq.com/ifzqgtimg/appstock/app/ReverseRepo/get?app=wzq';
const response = await fetch(url);
const json =  await response.json();
const isError = json == null || json.code != 0
const data = json.data.data;
const bestOnGivenDay = json.data.bestOnGivenDay;
const szData = data.sz;
const shData = data.sh;
const requestUrl =  new URL(Astro.request.url);
const buyAmount = requestUrl.searchParams.get('buyAmount') || 10;

---

<Layout  title="国债逆回购">
   <div class="mx-auto w-full min-w-max max-w-2xl">
    {
        isError && <p> 请求数据错误 </p>
    }

    { !isError &&
    <div class="form-control m-2 items-end">
        <div class="flex items-center">
            <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-red-500 mr-2"
                >
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            <span class="text-gray-700">购买金额：</span>
            <input class="border border-gray-300 rounded px-2 py-1 text-sm" placeholder={buyAmount} type="text" id="buyAmount" />
            <span>万元</span>
        </div>
    </div>

    <div class="text-end m-2 mb-0">
        <label class="swap">
            <input type="checkbox" class="toggle toggle-error -translate-x-10" id="toggle" checked />
            <div class="swap-on text-red-500">沪市</div>
            <div class="swap-off text-gray-500">深市</div>
        </label>
 
    </div>
    <div class="hidden box-border w-full mx-auto" id="szItem">
        {
            szData.sort((item1, item2) => {
                if(bestOnGivenDay.sc != 'sz') {
                    return 0;
                }
                if(bestOnGivenDay.term == item1.term) {
                    return -1;
                }
                if(bestOnGivenDay.term == item2.term) {
                    return 1;
                }
            }).map(item => {
                if(bestOnGivenDay.sc == 'sz' && bestOnGivenDay.term == item.term) {
                    item.bestOnGivenDay = true;
                }
                return <GCardV0 item={item} buyAmount={Number(buyAmount * 10000)} />
            } )
        }   
    </div>


    <div class="w-full box-border mx-auto" id="shItem">
        {
            shData.sort((item1, item2) => {
                if(bestOnGivenDay.sc != 'sh') {
                    return 0;
                }
                if(bestOnGivenDay.term == item1.term) {
                    return -1;
                }
                if(bestOnGivenDay.term == item2.term) {
                    return 1;
                }
            }).map(item => {
                if(bestOnGivenDay.sc == 'sh' && bestOnGivenDay.term == item.term) {
                    item.bestOnGivenDay = true;
                }
                return <GCardV0 item={item} buyAmount={Number(buyAmount * 10000)} />
            } )
        }   
    </div>

    }
    
   </div>
</Layout>

<script>

    let toggle=document.querySelector('#toggle');
    toggle?.addEventListener('click', function(e) {
        let res = e.target.checked;

        let szItem = document.querySelector('#szItem');
        let shItem = document.querySelector('#shItem');
        shItem.className = 'hidden';
        szItem.className = 'hidden';
        let className = 'box-border w-full mx-auto';
        if(res) {
            shItem.className = className;
        } else {
            szItem.className = className;
        }


    })

    let buyAmount = document.querySelector('#buyAmount');
    buyAmount.addEventListener('blur', function(e) {
        if(e.target.value == '') {
            return;
        }
        let url = new URL(window.location.href);
        url.searchParams.set('buyAmount', e.target.value);
        window.location.href = url.href;

    })
    buyAmount.addEventListener('keydown', (e) => {
        if (e.key != 'Enter') {
            return;
        }
        if(e.target.value == '') {
            return;
        }
        let url = new URL(window.location.href);
        url.searchParams.set('buyAmount', e.target.value);
        window.location.href = url.href;
    });


</script>